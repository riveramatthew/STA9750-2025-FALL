---
title: "STA 9750 Mini-Project #04: Just the Fact(-Check)s, Ma'am!"
subtitle: "BLS CES Employment Analysis and Fact-Checking"
author: "Your Name"
date: "2025-11-06"
format:
  html:
    toc: true
    code-fold: true
    code-tools: true
    embed-resources: true
    theme: cosmo
execute:
  echo: true
  warning: false
  message: false
---

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Load required libraries
library(tidyverse)
library(httr2)
library(rvest)
library(infer)
library(purrr)
library(knitr)
library(lubridate)
library(kableExtra)
```

# TASK 1: Download CES Total Nonfarm Payroll

```{r}
download_ces_estimates <- function() {
  # Step 1: Create HTTP request to BLS with proper headers
  # The BLS requires a User-Agent header to allow scraping
  base_url <- "https://data.bls.gov/pdq/SurveyOutputServlet"
 
  # Form data for the request - this accesses Total Nonfarm Employment, Seasonally Adjusted
  request_body <- list(
    activity = "output",
    svid = "406585", # Series ID for Total Nonfarm Employment, Seasonally Adjusted
    lstosavedquery = "",
    years_option = "all_years",
    beginyear = "1979",
    endyear = "2025",
    strtMonth = "01",
    endMonth = "06",
    calcopt = "net",
    format = "html"
  )
 
  # Make request with proper User-Agent
  response <- request(base_url) |>
    req_headers("User-Agent" = "Mozilla/5.0") |>
    req_body_form(!!!request_body) |>
    req_perform()
 
  # Step 2: Extract HTML and parse table
  html_content <- response_body_html(response)
 
  # Find the data table - typically the first large table on the page
  tables <- html_content |> html_elements("table")
 
  # The main data table is usually among the first tables
  data_table <- NULL
  for (i in seq_along(tables)) {
    table_df <- html_table(tables[[i]], header = TRUE)
    if (nrow(table_df) > 100) { # Main table should have many rows
      data_table <- table_df
      break
    }
  }
 
  # Step 3: Clean and pivot the data
  # The table typically has Year column followed by month columns
  ces_data <- data_table |>
    # Remove rows that are notes or summaries
    filter(!if_any(everything(), ~str_detect(as.character(.), "Preliminary|footnote|^---"))) |>
    # Pivot longer to get date-level data
    pivot_longer(
      cols = -Year,
      names_to = "month",
      values_to = "level"
    ) |>
    # Parse dates
    mutate(
      month_abbr = str_sub(month, 1, 3),
      date = ym(paste(Year, month_abbr)),
      level = as.numeric(str_remove(level, ","))
    ) |>
    select(date, level) |>
    drop_na() |>
    arrange(date) |>
    distinct()
 
  return(ces_data)
}
```

```{r}
# Download CES data
cat("Downloading CES Total Nonfarm Payroll data...\n")
ces_estimates <- download_ces_estimates()
```

```{r}
# Display sample
head(ces_estimates, 10) |> 
  kable(caption = "Sample of CES Payroll Data") |>
  kable_styling()
```

# TASK 2: Download CES Revisions

```{r}
extract_revisions_table <- function(year) {
  # Access the BLS revisions page
  url <- "https://www.bls.gov/web/empsit/cesnaicsrev.htm"
 
  # Make request with User-Agent
  response <- request(url) |>
    req_headers("User-Agent" = "Mozilla/5.0") |>
    req_perform()
 
  html_content <- response_body_html(response)
 
  # Find all tables on the page
  all_tables <- html_content |> html_elements("table")
 
  # Tables typically follow a naming pattern - find the one for our year
  target_table <- NULL
 
  for (table in all_tables) {
    # Check if this table contains the year we want
    table_text <- html_text(table)
    if (str_detect(table_text, as.character(year))) {
      target_table <- table
      break
    }
  }
 
  if (is.null(target_table)) {
    return(NULL)
  }
 
  # Extract table without headers (headers span multiple rows)
  table_body <- target_table |> html_element("tbody")
 
  if (is.null(table_body)) {
    table_data <- html_table(target_table, header = FALSE)
  } else {
    table_data <- table_body |> html_table(header = FALSE)
  }
 
  # Select relevant columns and name them
  # Typically: Month, Original Estimate, First Revision, Final Estimate, etc.
  revisions_df <- table_data |>
    slice(1:12) |> # Only 12 months per year
    select(month = 1, original = 2, final = 4) |> # Adjust column positions as needed
    mutate(
      # Parse values - remove commas and convert to numeric
      original = as.numeric(str_remove(original, ",")),
      final = as.numeric(str_remove(final, ",")),
      revision = final - original,
      date = ym(paste(year, month))
    ) |>
    select(date, original, final, revision) |>
    drop_na()
 
  return(revisions_df)
}
```

```{r}
download_ces_revisions_robust <- function() {
  url <- "https://www.bls.gov/web/empsit/cesnaicsrev.htm"
 
  response <- request(url) |>
    req_headers("User-Agent" = "Mozilla/5.0") |>
    req_perform()
 
  html_content <- response_body_html(response)
  all_tables <- html_content |> html_elements("table")
 
  # Extract all tables and combine
  all_revisions <- list()
  table_count <- 0
 
  for (table in all_tables) {
    table_count <- table_count + 1
   
    tryCatch({
      table_data <- html_table(table, header = FALSE)
     
      # Only process tables that look like revision tables (have numeric data)
      if (ncol(table_data) >= 4 && nrow(table_data) >= 12) {
        table_text <- html_text(table)
       
        # Try to extract year
        year_match <- str_extract(table_text, "\\b(19|20)\\d{2}\\b")
        if (!is.na(year_match)) {
          year <- as.numeric(year_match)
         
          rev_df <- table_data |>
            slice(1:12) |>
            select(month = 1, original = 2, final = 4) |>
            mutate(
              original = as.numeric(str_remove_all(original, "[^0-9.-]")),
              final = as.numeric(str_remove_all(final, "[^0-9.-]")),
              revision = final - original,
              date = ym(paste(year, month))
            ) |>
            select(date, original, final, revision) |>
            drop_na()
         
          all_revisions[[length(all_revisions) + 1]] <- rev_df
        }
      }
    }, error = function(e) {
      # Skip problematic tables
      return(NULL)
    })
  }
 
  return(bind_rows(all_revisions) |> distinct() |> arrange(date))
}
```

```{r}
# Use robust version
cat("Downloading CES Revisions data for 1979-2025...\n")
ces_revisions <- download_ces_revisions_robust()
```

```{r}
head(ces_revisions, 10) |> 
  kable(caption = "Sample of CES Revisions Data") |>
  kable_styling()
```

## Merge Datasets

```{r}
ces_combined <- ces_estimates |>
  left_join(
    ces_revisions,
    by = "date"
  ) |>
 stric  mutate(
    year = year(date),
    month = month(date),
    month_name = month(date, label = TRUE),
    revision_pct = (revision / final) * 100,
    revision_abs_pct = abs(revision) / final * 100
  ) |>
  drop_na(final) # Keep only rows where we have revision data

# Calculate month-over-month changes
ces_combined <- ces_combined |>
  arrange(date) |>
  mutate(
    level_change = level - lag(level),
    level_change_pct = (level - lag(level)) / lag(level) * 100
  )
```

# TASK 3: Exploratory Data Analysis - STATISTICS

```{r}
# Statistic 1: Summary statistics of revisions
stat1_summary <- ces_combined |>
  summarise(
    mean_revision = mean(revision, na.rm = TRUE),
    median_revision = median(revision, na.rm = TRUE),
    sd_revision = sd(revision, na.rm = TRUE),
    min_revision = min(revision, na.rm = TRUE),
    max_revision = max(revision, na.rm = TRUE),
    n_obs = n()
  )

cat("Statistic 1: Overall Revision Summary\n")
print(stat1_summary)

# Statistic 2: Revision trends by decade
stat2_by_decade <- ces_combined |>
  mutate(decade = paste0(year - (year %% 10), "s")) |>
  group_by(decade) |>
  summarise(
    mean_revision = mean(revision, na.rm = TRUE),
    median_abs_revision = median(abs(revision), na.rm = TRUE),
    pct_positive = mean(revision > 0, na.rm = TRUE) * 100,
    pct_negative = mean(revision < 0, na.rm = TRUE) * 100,
    n_obs = n()
  )

cat("\nStatistic 2: Revisions by Decade\n")
print(stat2_by_decade)

# Statistic 3: Largest revisions in history
stat3_largest <- ces_combined |>
  arrange(desc(abs(revision))) |>
  slice(1:10) |>
  select(date, revision, final, revision_pct) |>
  mutate(revision_pct = round(revision_pct, 2))

cat("\nStatistic 3: Top 10 Largest Revisions (Absolute Value)\n")
print(stat3_largest)

# Statistic 4: Revision patterns post-2000 vs pre-2000
stat4_pre_post <- ces_combined |>
  mutate(period = if_else(year < 2000, "Pre-2000", "Post-2000")) |>
  group_by(period) |>
  summarise(
    mean_revision = mean(revision, na.rm = TRUE),
    mean_abs_revision = mean(abs(revision), na.rm = TRUE),
    pct_positive = mean(revision > 0, na.rm = TRUE) * 100,
    pct_large_revision = mean(abs(revision_pct) > 0.1, na.rm = TRUE) * 100,
    n_obs = n()
  )

cat("\nStatistic 4: Pre-2000 vs Post-2000 Comparison\n")
print(stat4_pre_post)

# Statistic 5: Post-2020 trends
stat5_recent <- ces_combined |>
  filter(year >= 2020) |>
  summarise(
    mean_revision = mean(revision, na.rm = TRUE),
    mean_abs_revision = mean(abs(revision), na.rm = TRUE),
    pct_negative = mean(revision < 0, na.rm = TRUE) * 100,
    pct_revision_gt_1pct = mean(abs(revision_pct) > 1, na.rm = TRUE) * 100,
    largest_revision = max(abs(revision), na.rm = TRUE),
    n_obs = n()
  )

cat("\nStatistic 5: Post-2020 Employment Revisions\n")
print(stat5_recent)

# Statistic 6: Monthly patterns in revisions
stat6_by_month <- ces_combined |>
  group_by(month_name) |>
  summarise(
    mean_revision = mean(revision, na.rm = TRUE),
    mean_abs_revision = mean(abs(revision), na.rm = TRUE),
    pct_negative = mean(revision < 0, na.rm = TRUE) * 100,
    n_obs = n()
  ) |>
  arrange(desc(mean_abs_revision))

cat("\nStatistic 6: Seasonal Patterns - Mean Revisions by Month\n")
print(stat6_by_month)
```

# TASK 3: VISUALIZATIONS

```{r}
# Visualization 1: Time series of revisions with color by sign
ces_combined |>
  ggplot(aes(x = date, y = revision, color = revision > 0)) +
  geom_point(size = 2, alpha = 0.6) +
  geom_line(alpha = 0.3, linewidth = 0.3) +
  scale_color_manual(
    values = c("TRUE" = "#2ecc71", "FALSE" = "#e74c3c"),
    labels = c("TRUE" = "Positive (Upward)", "FALSE" = "Negative (Downward)"),
    name = "Revision Direction"
  ) +
  labs(
    title = "CES Employment Revisions Over Time (1979-2025)",
    subtitle = "Monthly final estimates adjusted from initial reports",
    x = "Date",
    y = "Revision (Thousands of Jobs)",
    caption = "Source: BLS Current Employment Statistics"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray60"),
    legend.position = "bottom"
  )
```
