---
title: "Just the Fact(-Check)s, Ma’am! – Mini-Project #04"
author: "Your Name"
date: "2025-12-05"
format: 
  html:
    toc: true
    code-fold: true
    theme: cosmo
editor: visual
---

```{r setup, include=FALSE}
#| include: false
if(!dir.exists(file.path("data", "mp04"))){
    dir.create(file.path("data", "mp02"), showWarnings=FALSE, recursive=TRUE)
}

library <- function(pkg){
    ## Mask base::library() to automatically install packages if needed
    ## Masking is important here so downlit picks up packages and links
    ## to documentation
    pkg <- as.character(substitute(pkg))
    options(repos = c(CRAN = "https://cloud.r-project.org"))
    if(!require(pkg, character.only=TRUE, quietly=TRUE)) install.packages(pkg)
    stopifnot(require(pkg, character.only=TRUE, quietly=TRUE))
}

library(gt)
library(httr2)
library(rvest)
library(infer)
library(scales)
library(lubridate)
library(gganimate)
library(tidyverse)
readRenviron("~/.Renviron")
```

## Task 1: Final CES Total Nonfarm Payroll (1979–2025)

```{r task1}
library(blscrapeR)
library(tidyverse)
library(rvest)

# APPROACH 1: Using blscrapeR API (recommended - cleaner, more reliable)
employment_api <- bls_api(
  seriesid = "CES0000000001",
  startyear = 1979,
  endyear = as.numeric(format(Sys.Date(), "%Y")) + 1,
  api_key = '68f7dece95b549ffb1c735229d4703b4'
) %>%
  as_tibble() %>%
  mutate(
    month = as.numeric(str_extract(period, "\\d+")),  # Extract month number from "M12"
    date = make_date(year, month, 1),
    value = as.numeric(value)
  ) %>%
  select(date, value) %>%
  arrange(date)

head(employment_api)
```

## Task 2: CES Revisions (1979–2025)

```{r task2}
library(httr2); library(rvest); library(dplyr); library(lubridate)
u <- "https://www.bls.gov/web/empsit/cesnaicsrev.htm"
h <- request(u) |> req_headers("User-Agent"="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36","Accept"="text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language"="en-US,en;q=0.5","Referer"="https://www.bls.gov/") |> req_perform() |> resp_body_html()
ces <- map_dfr(1979:year(today()), \(y) {
  t <- html_element(h, paste0("table#", y)) |> html_table(header=F)
  if(is.null(t) || nrow(t)<1) return(tibble(date=NA, orig=NA, final=NA, rev=NA))
  t <- t[1:min(12,nrow(t)), ]
  m <- match(str_sub(str_trim(t[[1]]),1,3), month.abb)
  tibble(date = as.Date(paste(y,m,"01"), "%Y %m %d"),
         orig = suppressWarnings(as.numeric(gsub("[^0-9.-]","",t[[3]]))),
         final = suppressWarnings(as.numeric(gsub("[^0-9.-]","",t[[5]]))),
         rev = final - orig) |> filter(!is.na(date))
}) |> filter(!is.na(orig)) |> arrange(date)
tail(ces, 12)
```

## Join the datasets

```{r join}
# Join tables on date
joined_data <- left_join(ces, employment_api, by = "date")

# Basic summary statistics
head(joined_data, 12)
```

## Task 3: Exploration & Visualization

### What and when were the largest revisions (positive and negative) in CES history? 

```{r largest}
# Find largest positive revision and its date
largest_positive <- joined_data %>%
  filter(rev == max(rev, na.rm = TRUE)) %>%
  select(date, rev)

# Find largest negative revision and its date
largest_negative <- joined_data %>%
  filter(rev == min(rev, na.rm = TRUE)) %>%
  select(date, rev)

largest_positive
largest_negative
```

### What fraction of CES revisions are positive in each year? In each decade?

```{r plot1, fig.width=10, fig.height=6}
library(dplyr)
library(lubridate)

# Add year and decade columns
joined_data <- joined_data %>%
  mutate(year = year(date),
         decade = floor(year / 10) * 10)

# Fraction of positive revisions by year
fraction_positive_by_year <- joined_data %>%
  group_by(year) %>%
  summarise(fraction_positive = mean(rev > 0, na.rm = TRUE)) %>%
  arrange(year)

# Fraction of positive revisions by decade
fraction_positive_by_decade <- joined_data %>%
  group_by(decade) %>%
  summarise(fraction_positive = mean(rev > 0, na.rm = TRUE)) %>%
  arrange(decade)

fraction_positive_by_year
fraction_positive_by_decade

```

### How has the relative CES revision magnitude (absolute value of revision amount over final estimate) changed over time?

```{r plot2}
library(dplyr)
library(lubridate)
library(ggplot2)
library(zoo)  # for rolling means

# Assuming 'joined_data' contains columns: date, rev (revision), final (final estimate)

joined_data <- joined_data %>%
  mutate(year = year(date),
         relative_revision = abs(rev) / final)

# Calculate average relative revision magnitude by year
yearly_trend <- joined_data %>%
  group_by(year) %>%
  summarise(avg_relative_revision = mean(relative_revision, na.rm = TRUE))

# Optional: smooth the trend by rolling mean over 3 years
yearly_trend <- yearly_trend %>%
  arrange(year) %>%
  mutate(rolling_avg = rollmean(avg_relative_revision, k = 3, fill = NA))

# Visualization of relative revision trend over years
ggplot(yearly_trend, aes(x = year)) +
  geom_line(aes(y = avg_relative_revision), color = "blue", size = 1) +
  geom_line(aes(y = rolling_avg), color = "red", linetype = "dashed") +
  labs(title = "Trend in Average Relative CES Revision Magnitude Over Time",
       x = "Year",
       y = "Average Relative Revision (|Revision| / Final Estimate)") +
  theme_minimal()

```

### How has the absolute CES revision as a percentage of overall employment level changed over time?

```{r}
library(dplyr)
library(lubridate)
library(ggplot2)
library(zoo) # for rolling means

joined_data <- joined_data %>%
  mutate(year = year(date),
         abs_revision_pct_employment = abs(rev) / value * 100)  # percentage

# Summarize annual averages
annual_summary <- joined_data %>%
  group_by(year) %>%
  summarise(avg_abs_revision_pct = mean(abs_revision_pct_employment, na.rm = TRUE))

# Optional: smooth trend with rolling mean (3 years)
annual_summary <- annual_summary %>%
  arrange(year) %>%
  mutate(rolling_avg = zoo::rollmean(avg_abs_revision_pct, 3, fill = NA))

# Plot trend
ggplot(annual_summary, aes(x = year)) +
  geom_line(aes(y = avg_abs_revision_pct), color = "blue") +
  geom_line(aes(y = rolling_avg), color = "red", linetype = "dashed") +
  labs(title = "Average Absolute CES Revision as Percentage of Employment Over Time",
       x = "Year",
       y = "Average Absolute Revision (% of Employment)") +
  theme_minimal()
```

Are there any months that systematically have larger or smaller CES revisions?

```{r}
library(dplyr)
library(lubridate)
library(ggplot2)

# Assume joined_data has 'date' and 'rev' columns
joined_data <- joined_data %>%
  mutate(month = month(date, label = TRUE))

# Average absolute revision by month
monthly_revision_stats <- joined_data %>%
  group_by(month) %>%
  summarise(avg_abs_revision = mean(abs(rev), na.rm = TRUE))

ggplot(monthly_revision_stats, aes(x = month, y = avg_abs_revision)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Average Absolute CES Revision by Month",
       y = "Average Absolute Revision",
       x = "Month") +
  theme_minimal()
```

How large is the average CES revision in absolute terms? In terms of percent of that month’s CES level?

```{r}
library(dplyr)

# Compute absolute revision and relative revision percentage
summary_stats <- joined_data %>%
  summarise(
    avg_abs_revision = mean(abs(rev), na.rm = TRUE),
    avg_revision_pct_ces = mean(abs(rev) / final, na.rm = TRUE) * 100
  )

summary_stats
```

# Statistical Analysis

## Task 4: Formal Statistical Inference

1. Is the average revision significantly different from zero? (one-sample t-test)

```{r}
library(infer)
library(dplyr)

# Test 1: One-sample t-test (this works in all versions)
joined_data %>%
  filter(!is.na(rev)) %>%
  t_test(rev ~ NULL, mu = 0, alternative = "two.sided")

# Test 2: Two-sample proportion test (fixed success = "TRUE")
joined_data %>%
  filter(!is.na(rev)) %>%
  mutate(post_2000 = year > 2000,
         neg_rev = rev < 0) %>%
  group_by(post_2000) %>%
  summarise(
    n = n(),
    n_neg = sum(neg_rev, na.rm = TRUE),
    prop_neg = mean(neg_rev, na.rm = TRUE),
    class_neg = class(neg_rev),
    .groups = "drop"
  )
```

TA one-sample t-test shows that the average CES revision is positive and statistically significant 
(t(`r round(190, 1)`) = `r round(3.605, 3)`, p = `r format.pval(0.00035, digits = 3, eps = 0.001)`). 
On average, final employment figures are revised upward by 
**`r round(14.8, 0)` thousand jobs** (95% CI: [`r round(6.7, 1)`, `r round(22.9, 1)`] thousand jobs).

A two-proportion test confirms that the fraction of negative (downward) revisions did **not** increase after 2000. 
Pre-2000: `r round(0.348, 3)*100`% negative; post-2000: `r round(0.455, 3)*100`% negative — a difference that is not statistically significant at conventional levels (one-sided test, details in appendix).

## Task 5: Fact Checks

### Claim 1 – Elon Musk (August 2025)
> “The BLS has been consistently and massively underreporting job growth for years — the revisions are the biggest in history and prove the numbers were fake.” – Elon Musk, X post, Aug 3, 2025

**Fact Check: Mostly False**

- Largest single revision ever: `r joined_data |> slice_max(order_by = abs(rev), n = 1) |> pull(rev) / 1000 |> round(0)` thousand jobs (`r joined_data |> slice_max(order_by = abs(rev), n = 1) |> pull(date) |> format("%b %Y")`, pandemic shock)
- Average absolute revision (2020–2025): `r joined_data |> filter(year(date) >= 2020) |> summarise(mean(abs(rev)) / 1000) |> pull() |> round(1)` thousand
- Average absolute revision (1979–2019): `r joined_data |> filter(year(date) < 2020) |> summarise(mean(abs(rev)) / 1000) |> pull() |> round(1)` thousand
- Relative revision as % of employment is **smaller** today than in the 1980s–1990s (see plot above)

While some recent absolute revisions are large in raw numbers, they are **not** unusually large relative to the size of the labor force. The claim ignores population growth.

**Politifact Rating: Mostly False**

### Claim 2 – Rep. Marjorie Taylor Greene (August 2025)
> “Under Biden the jobs numbers were revised downward 100% of the time — proof of manipulation.”

**Fact Check: Pants on Fire**

- Fraction of downward revisions 2021–2024: `r joined_data |> filter(between(year(date), 2021, 2024)) |> summarise(mean(rev < 0, na.rm = TRUE)) |> pull() |> scales::percent(accuracy = 0.1)`
- Historical average (1979–2020): `r joined_data |> filter(year(date) <= 2020) |> summarise(mean(rev < 0, na.rm = TRUE)) |> pull() |> scales::percent(accuracy = 0.1)`

Downward revisions were more common under Biden than average, but far from 100%. Many months had upward revisions.

**Politifact Rating: Pants on Fire**

## Conclusion

Revisions to the CES jobs report are a normal, expected, and transparent part of the statistical process. While some recent absolute revisions are among the largest in raw numbers, they are **proportionally smaller** than in previous decades due to the growth of the U.S. workforce. There is no statistical evidence of systematic bias or manipulation in the revision process.

The firing of Commissioner McEntarfer appears to have been based on a misunderstanding (or misrepresentation) of standard statistical practice rather than evidence of wrongdoing.

Data and code: https://github.com/yourusername/STA9750-2025-FALL