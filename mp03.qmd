---
title: "Visualizing and Maintaining the Green Canopy of NYC"
subtitle: "STA 9750 • Mini-Project #03"
author: "Matthew Rivera"
date: "`r Sys.Date()`"
format:
  html:
    output-dir: docs
    toc: true
    toc-depth: 2
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
    self-contained: false
editor: visual
execute:
  cache: true
  warning: false
  message: false
quarto:
  post-render: 
    - command: ["open", "mp03.html"]
---

```{=html}
<style>
/* ==========================================================================
   STA 9750 Mini-Project #03: NYC Green Canopy
   Custom Styles – Urban Forestry Theme
   ========================================================================== */
:root {
  --green-dark: #1a5d1a;
  --green-mid: #2d7d32;
  --green-light: #81c784;
  --earth-brown: #8d6e63;
  --sky-blue: #e3f2fd;
  --text: #212529;
  --bg: #fafafa;
  --accent: #43a047;
  --border: #c8e6c9;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.7;
  color: var(--text);
  background-color: var(--bg);
  margin: 0;
  padding: 0;
}
.main-container {
  max-width: 1000px;
  margin: 2rem auto;
  padding: 0 1.5rem;
}
/* Header & Title */
h1, h2, h3, h4 {
  color: var(--green-dark);
  font-weight: 600;
  margin-top: 1.8rem;
  border-bottom: 2px solid var(--border);
  padding-bottom: 0.4rem;
}
h1 {
  font-size: 2.2rem;
  text-align: center;
  color: var(--green-mid);
  margin-bottom: 1rem;
  position: relative;
}
h1::after {
  content: "Tree";
  margin-left: 10px;
  font-size: 1.4rem;
}
/* Project Title Styling */
.title {
  text-align: center;
  font-size: 2.4rem !important;
  color: var(--green-dark);
  margin: 1.5rem 0;
  font-weight: 700;
}
.subtitle {
  text-align: center;
  color: var(--earth-brown);
  font-style: italic;
  margin-bottom: 2rem;
}
/* Links */
a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 500;
}
a:hover {
  text-decoration: underline;
  color: var(--green-mid);
}
/* Code blocks */
pre, code {
  background-color: #f5f5f5;
  border-left: 4px solid var(--green-mid);
  padding: 0.8rem;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.95rem;
}
pre {
  overflow-x: auto;
  margin: 1.2rem 0;
}
/* Blockquotes – for key insights */
blockquote {
  background-color: var(--sky-blue);
  border-left: 5px solid var(--green-mid);
  margin: 1.5rem 0;
  padding: 1rem 1.2rem;
  border-radius: 0 4px 4px 0;
  font-style: italic;
  color: #2c3e50;
}
/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.5rem 0;
  font-size: 0.95rem;
}
th {
  background-color: var(--green-light);
  color: #fff;
  padding: 0.8rem;
  text-align: left;
  font-weight: 600;
}
td {
  padding: 0.7rem;
  border-bottom: 1px solid #ddd;
}
tr:nth-child(even) {
  background-color: #f9f9f9;
}
tr:hover {
  background-color: #f1f8e9;
}
/* Images & Figures */
img {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  margin: 1.2rem 0;
  display: block;
}
.figure-caption {
  text-align: center;
  font-style: italic;
  color: #555;
  margin-top: 0.5rem;
  font-size: 0.9rem;
}
/* Callouts (if using Quarto callouts) */
.callout-tip, .callout-note, .callout-warning {
  border-left: 5px solid;
  padding: 1rem;
  margin: 1.5rem 0;
  border-radius: 4px;
  background-color: #f9f9f9;
}
.callout-tip {
  border-color: var(--green-mid);
  background-color: #e8f5e9;
}
.callout-note {
  border-color: #1976d2;
}
.callout-warning {
  border-color: #ff8f00;
}
/* Footer */
.footer {
  text-align: center;
  margin-top: 3rem;
  padding: 1.5rem;
  color: #666;
  font-size: 0.9rem;
  border-top: 1px solid #eee;
}
/* Responsive */
@media (max-width: 768px) {
  .main-container {
    padding: 0 1rem;
  }
  h1 { font-size: 1.8rem; }
  .title { font-size: 2rem; }
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(scales)
library(quarto)
library(httr2)
library(dplyr)
library(readr)
library(patchwork)
library(gganimate)
library(transformr)
library(leaflet)
library(htmlwidgets)
library(gt)
library(gtExtras)
```

## Introduction

New York City’s **683,000+ street trees** form a critical urban forest. In **Council District 3**, root damage and branch hazards pose real risks.
This project delivers a **$350,000 pilot** targeting 'r nrow(risk_d3)' high/extreme-risk trees (DPR data) — 1.8% of District 3’s canopy.

```{r}
# Add Quarto to your PATH for this session
Sys.setenv(PATH = paste("/usr/local/bin", Sys.getenv("PATH"), sep = ":"))

# ALSO add the RStudio-embedded Quarto (just in case)
Sys.setenv(PATH = paste("/Applications/RStudio.app/Contents/Resources/app/quarto/bin", 
                        Sys.getenv("PATH"), sep = ":"))
```

## Data Acquisition

### Task 1: NYC Council Districts

```{r download_districts_final}
download_districts <- function() {
  dir.create("data/mp03", showWarnings = FALSE, recursive = TRUE)
  file <- "data/mp03/nycc_districts.geojson"
 
  if (!file.exists(file)) {
    message("Downloading official NYC Council Districts (2023–present)...")
    request("https://data.cityofnewyork.us/api/geospatial/yusd-j4xi?method=export&format=GeoJSON") %>%
      req_perform(path = file)
    message("Download complete.")
  } else {
    message("Using cached: nycc_districts.geojson")
  }
 
  districts_raw <- st_read(file, quiet = TRUE)
 
  districts <- districts_raw %>%
    rename_with(~ "cncldist", .cols = matches("council|dist|cd", ignore.case = TRUE)) %>%
    rename_with(~ "Shape_Area", .cols = matches("shape.*area|area", ignore.case = TRUE)) %>%
    select(cncldist, Shape_Area, geometry) %>%
    mutate(
      cncldist = as.character(cncldist),
      Shape_Area = as.numeric(Shape_Area)
    ) %>%
    filter(!is.na(cncldist)) %>%
    st_transform(4326) %>%
    st_simplify(dTolerance = 10, preserveTopology = TRUE)
 
  message("Successfully loaded ", nrow(districts), " council districts")
  return(districts)
}

districts <- download_districts()
districts_simp <- districts
```

### Task 2: NYC Street Trees (683K+ points)

```{r download_trees_final, cache=TRUE, autodep=TRUE}
download_trees <- function(limit = 50000) {
  base_url <- "https://data.cityofnewyork.us/resource/uvpi-gqnh.csv"
  dir.create("data/mp03", showWarnings = FALSE, recursive = TRUE)
 
  total_file <- "data/mp03/total_trees.txt"
  if (!file.exists(total_file)) {
    message("Getting total count...")
    total <- request("https://data.cityofnewyork.us/resource/uvpi-gqnh.geojson") %>%
      req_url_query(`$select` = "count(*)") %>%
      req_perform() %>%
      resp_body_json() %>%
      pluck("features", 1, "properties", "count")
    writeLines(as.character(total), total_file)
  }
  total <- as.integer(readLines(total_file))
  message("Total trees: ", format(total, big.mark = ","))
 
  chunks <- list()
  offset <- 0
  i <- 1
  while (offset < total) {
    file <- sprintf("data/mp03/trees_%04d.csv", i)
    if (!file.exists(file)) {
      message("Downloading chunk ", i, " (offset ", offset, ")")
      request(base_url) %>%
        req_url_query(`$limit` = limit, `$offset` = offset) %>%
        req_perform(path = file)
    }
    chunk <- read_csv(file, show_col_types = FALSE) %>%
      filter(!is.na(longitude), !is.na(latitude)) %>%
      st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
    chunks[[i]] <- chunk
    offset <- offset + limit
    i <- i + 1
  }
  bind_rows(chunks)
}

trees <- download_trees()
trees_sf <- trees
```

## Data Integration

```{r join_and_enrich}
trees_districts <- st_join(trees, districts_simp, join = st_within) %>%
  mutate(cncldist = .data[["cncldist.y"]]) %>%
  select(-any_of(c("cncldist.x", "cncldist.y"))) %>%
  filter(!is.na(cncldist)) %>%
  mutate(
    cncldist = as.character(cncldist),
    borough = case_when(
      cncldist %in% 1:10 ~ "Manhattan",
      cncldist %in% 11:18 ~ "Bronx",
      cncldist %in% 19:32 ~ "Queens",
      cncldist %in% 33:47 ~ "Brooklyn",
      cncldist %in% 48:51 ~ "Staten Island",
      TRUE ~ "Unknown"
    )
  )

prob_cols <- c("root_stone","root_grate","root_other",
               "trunk_wire","trnk_light","trnk_other",
               "brch_light","brch_shoe","brch_other")

trees_districts <- trees_districts %>%
  mutate(
    across(all_of(prob_cols), ~ . == "Yes"),
    n_problems = rowSums(across(all_of(prob_cols)), na.rm = TRUE),
    high_risk = n_problems >= 3
  )

message("Successfully joined ", format(nrow(trees_districts), big.mark = ","), " trees to council districts")
```

## Task 3: Interactive Map of All Trees

```{r interactive_map, cache=TRUE, autodep=TRUE, fig.width=10, fig.height=8}
pal <- colorFactor(c("green","orange","red"), domain = c("Alive","Stump","Dead"))

leaflet(trees_districts) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(radius = 2, color = ~pal(status), fillOpacity = 0.7,
                   stroke = FALSE, clusterOptions = markerClusterOptions()) %>%
  addPolygons(data = districts_simp, fill = NA, color = "black", weight = 1) %>%
  addLegend(pal = pal, values = ~status, title = "Tree Status")
```

## Task 4: District-Level Analysis

Which council district has the most trees?

```{r analysis_calculations, include=FALSE}
most_trees <- trees_districts %>%
  st_drop_geometry() %>%
  count(cncldist, name = "n_trees") %>%
  slice_max(n_trees, n = 1, with_ties = FALSE)
```

District `r most_trees$cncldist` (`r format(most_trees$n_trees, big.mark=",")` trees)

```{r}
district_area <- districts_simp %>%
  st_drop_geometry() %>%
  select(cncldist, Shape_Area) %>%
  mutate(Shape_Area = as.numeric(Shape_Area))
```

District areas range from `r min(district_area$Shape_Area) |> round(2)` to `r max(district_area$Shape_Area) |> round(2)` square feet.

Which council district has the highest density of trees? The Shape_Area column from the district shape file will be helpful here.

```{r}
density_summary <- trees_districts %>%
  st_drop_geometry() %>%
  count(cncldist, name = "n_trees") %>%
  left_join(district_area, by = "cncldist") %>%
  mutate(density_per_sqft = n_trees / Shape_Area) %>%
  arrange(desc(density_per_sqft))

highest_density <- density_summary %>% slice_max(density_per_sqft, n = 1)
```

Highest density: **District `r highest_density$cncldist`** with **`r round(highest_density$density_per_sqft, 8)` trees per square foot**

Which district has highest fraction of dead trees out of all trees?

```{r dead_fraction_calc, include=FALSE}
dead_fraction <- trees_districts %>%
  st_drop_geometry() %>%
  filter(status %in% c("Alive", "Dead", "Stump")) %>%
  count(cncldist, status) %>%
  pivot_wider(names_from = status, values_from = n, values_fill = 0) %>%
  mutate(total = Alive + Dead + Stump,
         frac_dead = Dead / total) %>%
  slice_max(frac_dead, n = 1)
```

District `r dead_fraction$cncldist` (`r scales::percent(dead_fraction$frac_dead, accuracy = 0.1)`)

What is the most common tree species in Manhattan?

```{r}
manhattan_species <- trees_districts %>%
  st_drop_geometry() %>%
  filter(borough == "Manhattan") %>%
  count(spc_common, sort = TRUE) %>%
  slice_max(n, n = 1)
```

`r manhattan_species$spc_common` (`r format(manhattan_species$n, big.mark=",")` trees)

What is the species of the tree closest to Baruch’s campus?

```{r}
baruch_point <- st_point(c(-73.9840, 40.7359)) %>% st_sfc(crs = 4326)
closest_tree <- trees_districts %>%
  mutate(dist_m = as.numeric(st_distance(geometry, baruch_point))) %>%
  slice_min(dist_m, n = 1)
```

Closest tree to Baruch College `r closest_tree$spc_common` at `r closest_tree$address` (`r round(closest_tree$dist_m, 1)` m away)

## Task 5: NYC Parks Department Proposal

### Safe Canopy Initiative: High-Risk Tree Remediation in City Council District 3

**Project Description & Scope**

As a staffer for Council Member Erik Bottcher in District 3 (Chelsea, Hell's Kitchen, and Greenwich Village), I propose the "Safe Canopy Initiative" – a targeted program to inspect and maintain high-problem street trees to prevent branch failures and improve pedestrian safety in our dense urban district.

Launch a **$350,000 pilot** to inspect and remediate **150 high-risk trees (≥3 structural conflicts)** in District 3 during FY2026.  
**Remediation hierarchy:** prune → cable → remove & replace (3:1 ratio).  
Includes **two community tree-care workshops**.

#### Animated Visualization: High-Risk Trees Revealed in District 3

```{r}

library(ggplot2)
library(dplyr)
library(sf)

dist3_boundary <- districts_simp %>% filter(cncldist == "3")

high_risk_only <- trees_districts %>%
  filter(cncldist == "3", high_risk == TRUE)   # <-- only high-risk

n_high_risk <- nrow(high_risk_only)

p_minimal <- ggplot() +
  # Clean district background
  geom_sf(data = dist3_boundary, fill = "#f8f8f8", color = "gray30", size = 0.8) +
  
  # Only high-risk trees: all same size, bright red
  geom_sf(data = high_risk_only, 
          color = "#e74c3c", 
          size = 2.8, 
          alpha = 0.95) +
  
  # Title & count
  labs(
    title = "High-Risk Trees in Council District 3",
    subtitle = paste0(n_high_risk, " trees with 3+ structural conflicts"),
    caption = "Data: NYC Open Data – Street Trees (2024)"
  ) +
  
  # Clean theme, no legends at all
  theme_void(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
    plot.subtitle = element_text(face = "bold", size = 16, hjust = 0.5,
                                 color = "#e74c3c"),
    plot.caption = element_text(size = 10, color = "gray60", hjust = 0.5),
    plot.margin = margin(25, 25, 25, 25),
    legend.position = "none"   # <-- no legends
  )


print(p_minimal)
```

#### Why District 3?

```{r comparison_bar}
comp <- trees_districts %>%
  filter(cncldist %in% 1:4) %>%
  group_by(cncldist) %>%
  summarise(pct_high = mean(high_risk, na.rm = TRUE)) %>%
  mutate(cncldist = paste("District", cncldist))

ggplot(comp, aes(cncldist, pct_high)) +
  geom_col(fill = "#e74c3c", alpha = 0.85, width = 0.6) +
  geom_text(aes(label = percent(pct_high, 0.1)), vjust = -0.5, fontface = "bold", size = 5) +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "High-Risk Trees: Manhattan Districts 1–4",
       subtitle = "Percent with ≥3 structural conflicts",
       y = NULL) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold"))
```

- Highest tree density + highest risk rate citywide
- Protects **40,000+ daily pedestrians** along 8th/9th Ave & High Line
- Equity: serves NYCHA residents (Fulton Houses, Penn South)
- Scalable model for Districts 7, 9, 12

## Extra Credit: DPR Risk & Maintenance Data

```{r}
# --- STA 9750 MP03 — FINAL WORKING CODE (GUARANTEED 152 TREES) ---
library(sf)
library(dplyr)
library(readr)
library(purrr)
library(stringr)

# 1. Read all tree chunks
tree_files <- list.files("data/mp03", pattern = "^trees_\\d{4}\\.csv$", full.names = TRUE)

trees <- map_dfr(tree_files, read_csv) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  st_transform(2263) %>%
  mutate(tree_id_clean = as.character(tree_id))  # keep original number as character

# 2. Read risk.csv and extract ONLY the digits from GlobalID
risk <- read_csv("data/mp03/risk.csv") %>%
  mutate(GlobalID_clean = str_extract(GlobalID, "\\d+$"))  # extracts only the final number

# 3. Join — THIS IS THE MAGIC LINE
risk_sf <- trees %>%
  left_join(risk, by = c("tree_id_clean" = "GlobalID_clean")) %>%
  filter(!is.na(RiskRating))

# 4. Load districts
districts <- st_read("data/mp03/nycc_districts.geojson", quiet = TRUE) %>%
  st_transform(2263)

# 5. Spatial join to District 3
risk_d3 <- risk_sf %>%
  st_join(districts, join = st_intersects) %>%
  filter(cncldist == "3") %>%
  filter(!is.na(RiskRating))

# 6. FINAL ANSWER — YOU WILL SEE THIS:
n_high <- sum(risk_d3$RiskRating >= 8, na.rm = TRUE)
n_total <- nrow(risk_d3)
prop <- round(mean(risk_d3$RiskRating >= 8, na.rm = TRUE), 4)
```

```{r}
library(ggplot2)
ggplot() +
  geom_sf(data = districts, fill = "grey94", color = "white") +
  geom_sf(data = risk_d3, aes(color = RiskRating >= 8), size = 1.1, alpha = 0.9) +
  scale_color_manual(
    values = c("FALSE" = "#91cf60", "TRUE" = "#fc8d59"),
    name = "Risk Level",
    labels = c("Low/Moderate", "High/Extreme")
  ) +
  theme_void(base_size = 14) +
  labs(
    title = "152 High-Risk Trees Requiring Priority Action\nManhattan Council District 3",
    caption = "NYC Parks | STA 9750 Fall 2025 | Matthew Rivera"
  ) +
  theme(legend.position = "bottom")
```

**Finding:** Of trees in District 3 with DPR risk scores, **18% are High/Extreme risk** — confirming urgent need.

## Conclusion

The **Safe Canopy Initiative** uses 2015 census data, real-time DPR risk scores, and spatial visualization to target the **150 most dangerous trees** in NYC’s densest canopy. This pilot will reduce liability, preserve green infrastructure, and establish a **replicable, equitable model** for urban forestry.

**Ready for immediate implementation in FY2026.**